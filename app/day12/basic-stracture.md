
## 基本設計書： `useOptimistic`を使った「いいね」機能

### 1\. プロジェクト概要

ユーザーのアクション（「いいね」）に対し、UIを即座に更新することで、体感速度を向上させるOptimistic UIパターンを実装する。React 19の新フック `useOptimistic` と、Next.jsのServer Actionsを組み合わせて、モダンなWebアプリケーションの応答性を体験する。

### 2\. 目的

  - React 19の `useOptimistic` フックの基本的な使い方を習得する。
  - サーバーからの応答を待たずにUIを更新する「Optimistic UI」の概念を理解する。
  - Server Actionsと連携し、成功時と失敗時（任意）のUIの状態遷移を正しくハンドリングする方法を学ぶ。

### 3\. 主要機能

  - **投稿一覧表示機能**: 複数の投稿（タイトルと現在のいいね数）を一覧で表示する。
  - **いいね機能**: 各投稿に設置された「いいね」ボタンをクリックできる。
  - **即時UI更新機能**: ボタンをクリックすると、待ち時間なしで画面上のいいね数が即座に増加する。
  - **データ永続化機能**: バックグラウンドでServer Actionが実行され、サーバー側（今回はデモのため、サーバーのメモリ上）のいいね数を更新する。

### 4\. 技術スタック

  - Next.js 15 (App Router)
  - React 19 (`useOptimistic` フック)
  - Server Actions
  - TypeScript
  - Tailwind CSS

### 5\. 画面設計

  - **URL**: `/day12`
  - **レイアウト**:
      - ページ上部に「Day12: `useOptimistic` いいね機能」などのタイトルを配置。
      - その下に、複数の「投稿カード」を縦に並べて表示する。
  - **投稿カードの要素**:
      - 投稿のタイトル（例：「Reactの新しいフック」）。
      - 「いいね」ボタンと現在のいいね数を表示するエリア。

### 6\. データモデル

  - **`Post` 型**: 投稿一つ分のデータ構造を定義する。

    ```typescript:app/day12/types.ts
    export type Post = {
      id: number;
      title: string;
      likes: number;
    };
    ```

  - **擬似データベース**: 本物のデータベースの代わりに、サーバー側で投稿データを保持するシンプルな配列を用意する。

### 7\. コンポーネント設計

  - **`app/day12/page.tsx` (Server Component)**

      - ページの骨格となるサーバーコンポーネント。
      - サーバー上で擬似データベースから投稿の初期データを取得する。
      - 取得したデータを `PostList` コンポーnentにpropsとして渡す。

  - **`app/day12/components/PostList.tsx` (Client Component)**

      - `'use client'` ディレクティブを持つクライアントコンポーネント。
      - `page.tsx` から投稿データを受け取る。
      - **`useOptimistic` フックをこのコンポーネントで定義し、すべての状態管理ロジックを担う。**
      - 投稿データをループ処理し、各投稿の情報を表示する。
      - 「いいね」ボタンのクリックイベントを処理するフォームとServer Actionを定義する。

### 8\. 処理フロー

ユーザーが「いいね」ボタンをクリックした際の処理の流れは以下の通りです。

1.  **初期表示**:

      - `page.tsx` がサーバー上で投稿データを取得し、`PostList` に渡す。
      - `PostList` は受け取ったデータを「現実のstate」として保持し、`useOptimistic` を初期化する。UIには「楽観的なstate」が表示される（この時点では両者は同じ）。

2.  **ユーザー操作**:

      - ユーザーが特定の投稿の「いいね」ボタンをクリックする。

3.  **クライアントサイド (即時)**:

      - `useOptimistic` の更新関数が実行され、「楽観的なstate」のいいね数が `+1` される。
      - ReactがUIを再レンダリングし、ユーザーの画面ではいいね数が即座に増える。

4.  **サーバーサイド (バックグラウンド)**:

      - `form` の `action` として定義されたServer Actionが非同期で実行される。
      - Server Actionは、対象の投稿IDを受け取り、サーバー上のデータ（擬似データベース）のいいね数を `+1` する。
        \-（動作確認のため、意図的に1秒程度の遅延を入れる）

5.  **処理完了**:

      - Server Actionが完了すると、Next.jsが自動的にページを再検証（revalidate）する。
      - `page.tsx` が再度サーバー上で最新の投稿データを取得し、`PostList` に渡す。
      - `PostList` の「現実のstate」が更新され、「楽観的なstate」もそれに追従する。結果として、UIに変化はないように見える。
      - もしServer Actionが失敗した場合、「楽観的なstate」は破棄され、UIは自動的に元の「現実のstate」に戻る。